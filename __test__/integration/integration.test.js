const q = require("../../src/query");
const fs = require("fs");
const path = require("path");
const axios = require("axios");

// if needed
const og_axios = jest.requireActual("axios")

jest.mock('axios');

describe("Integration test", () => {
    describe("Integration test using mygene.info gene to biological process association", () => {
        let edge;

        beforeEach(() => {
            const edge_path = path.resolve(__dirname, '../data/mygene_example_edge.json');
            edge = JSON.parse(fs.readFileSync(edge_path));
        })
        test("check response", async () => {
            //mocking
            axios.mockResolvedValue({data: [{"query":"1017","_id":"1017","_score":25.32543,"go":{"BP":[{"evidence":"IBA","gocategory":"BP","id":"GO:0000082","pubmed":21873635,"qualifier":"involved_in","term":"G1/S transition of mitotic cell cycle"},{"evidence":"NAS","gocategory":"BP","id":"GO:0000086","pubmed":1653904,"qualifier":"involved_in","term":"G2/M transition of mitotic cell cycle"},{"evidence":"IEA","gocategory":"BP","id":"GO:0000122","qualifier":"involved_in","term":"negative regulation of transcription by RNA polymerase II"},{"evidence":"TAS","gocategory":"BP","id":"GO:0006260","pubmed":19238148,"qualifier":"involved_in","term":"DNA replication"},{"evidence":"IEA","gocategory":"BP","id":"GO:0006281","qualifier":"involved_in","term":"DNA repair"},{"evidence":"IEA","gocategory":"BP","id":"GO:0006351","qualifier":"involved_in","term":"DNA-templated transcription"},{"evidence":"IBA","gocategory":"BP","id":"GO:0006468","pubmed":21873635,"qualifier":"involved_in","term":"protein phosphorylation"},{"evidence":"IDA","gocategory":"BP","id":"GO:0006468","pubmed":[12944431,28666995],"qualifier":"involved_in","term":"protein phosphorylation"},{"evidence":"IMP","gocategory":"BP","id":"GO:0006468","pubmed":29203878,"qualifier":"involved_in","term":"protein phosphorylation"},{"evidence":"IEA","gocategory":"BP","id":"GO:0006813","qualifier":"involved_in","term":"potassium ion transport"},{"evidence":"IMP","gocategory":"BP","id":"GO:0007099","pubmed":26297806,"qualifier":"involved_in","term":"centriole replication"},{"evidence":"IBA","gocategory":"BP","id":"GO:0007165","pubmed":21873635,"qualifier":"involved_in","term":"signal transduction"},{"evidence":"IEP","gocategory":"BP","id":"GO:0007265","pubmed":9054499,"qualifier":"involved_in","term":"Ras protein signal transduction"},{"evidence":"IDA","gocategory":"BP","id":"GO:0008284","pubmed":10767298,"qualifier":"involved_in","term":"positive regulation of cell population proliferation"},{"evidence":"IBA","gocategory":"BP","id":"GO:0010033","pubmed":21873635,"qualifier":"involved_in","term":"response to organic substance"},{"evidence":"IBA","gocategory":"BP","id":"GO:0010389","pubmed":21873635,"qualifier":"involved_in","term":"regulation of G2/M transition of mitotic cell cycle"},{"evidence":"IBA","gocategory":"BP","id":"GO:0010468","pubmed":21873635,"qualifier":"involved_in","term":"regulation of gene expression"},{"evidence":"IEA","gocategory":"BP","id":"GO:0016570","qualifier":"involved_in","term":"histone modification"},{"evidence":"IDA","gocategory":"BP","id":"GO:0018105","pubmed":23184662,"qualifier":"involved_in","term":"peptidyl-serine phosphorylation"},{"evidence":"IDA","gocategory":"BP","id":"GO:0031453","pubmed":20935635,"qualifier":"involved_in","term":"positive regulation of heterochromatin formation"},{"evidence":"TAS","gocategory":"BP","id":"GO:0031571","pubmed":21319273,"qualifier":"involved_in","term":"mitotic G1 DNA damage checkpoint signaling"},{"evidence":"IEA","gocategory":"BP","id":"GO:0032298","qualifier":"involved_in","term":"positive regulation of DNA-templated DNA replication initiation"},{"evidence":"IDA","gocategory":"BP","id":"GO:0043687","pubmed":11746698,"qualifier":"involved_in","term":"post-translational protein modification"},{"evidence":"IEA","gocategory":"BP","id":"GO:0045893","qualifier":"involved_in","term":"positive regulation of DNA-templated transcription"},{"evidence":"TAS","gocategory":"BP","id":"GO:0051298","pubmed":19238148,"qualifier":"involved_in","term":"centrosome duplication"},{"evidence":"IEA","gocategory":"BP","id":"GO:0051301","qualifier":"involved_in","term":"cell division"},{"evidence":"TAS","gocategory":"BP","id":"GO:0051321","pubmed":19238148,"qualifier":"involved_in","term":"meiotic cell cycle"},{"evidence":"TAS","gocategory":"BP","id":"GO:0071732","pubmed":20079829,"qualifier":"involved_in","term":"cellular response to nitric oxide"},{"evidence":"TAS","gocategory":"BP","id":"GO:0090398","qualifier":"involved_in","term":"cellular senescence"},{"evidence":"TAS","gocategory":"BP","id":"GO:1905784","qualifier":"involved_in","term":"regulation of anaphase-promoting complex-dependent catabolic process"}]}}]})
            axios.post.mockResolvedValue({data: {"GO:0000082":{"id":{"identifier":"GO:0000082","label":"G1/S transition of mitotic cell cycle"},"equivalent_identifiers":[{"identifier":"GO:0000082","label":"G1/S transition of mitotic cell cycle"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":100},"GO:0000086":{"id":{"identifier":"GO:0000086","label":"G2/M transition of mitotic cell cycle"},"equivalent_identifiers":[{"identifier":"GO:0000086","label":"G2/M transition of mitotic cell cycle"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":100},"GO:0000122":{"id":{"identifier":"GO:0000122","label":"negative regulation of transcription by RNA polymerase II"},"equivalent_identifiers":[{"identifier":"GO:0000122","label":"negative regulation of transcription by RNA polymerase II"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":74.4},"GO:0006260":{"id":{"identifier":"GO:0006260","label":"DNA replication"},"equivalent_identifiers":[{"identifier":"GO:0006260","label":"DNA replication"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":80.7},"GO:0006281":{"id":{"identifier":"GO:0006281","label":"DNA repair"},"equivalent_identifiers":[{"identifier":"GO:0006281","label":"DNA repair"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":71.9},"GO:0006351":{"id":{"identifier":"GO:0006351","label":"transcription, DNA-templated"},"equivalent_identifiers":[{"identifier":"GO:0006351","label":"transcription, DNA-templated"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":74.4},"GO:0006468":{"id":{"identifier":"GO:0006468","label":"protein phosphorylation"},"equivalent_identifiers":[{"identifier":"GO:0006468","label":"protein phosphorylation"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":70.1},"GO:0006813":{"id":{"identifier":"GO:0006813","label":"potassium ion transport"},"equivalent_identifiers":[{"identifier":"GO:0006813","label":"potassium ion transport"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":88.2},"GO:0007099":{"id":{"identifier":"GO:0007099","label":"centriole replication"},"equivalent_identifiers":[{"identifier":"GO:0007099","label":"centriole replication"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":100},"GO:0007165":{"id":{"identifier":"GO:0007165","label":"signal transduction"},"equivalent_identifiers":[{"identifier":"GO:0007165","label":"signal transduction"}],"type":["biolink:Pathway","biolink:OntologyClass","biolink:BiologicalProcess","biolink:Occurrent","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":51.9},"GO:0007265":{"id":{"identifier":"GO:0007265","label":"Ras protein signal transduction"},"equivalent_identifiers":[{"identifier":"GO:0007265","label":"Ras protein signal transduction"}],"type":["biolink:Pathway","biolink:OntologyClass","biolink:BiologicalProcess","biolink:Occurrent","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":81.8},"GO:0008284":{"id":{"identifier":"GO:0008284","label":"positive regulation of cell population proliferation"},"equivalent_identifiers":[{"identifier":"GO:0008284","label":"positive regulation of cell population proliferation"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":66.8},"GO:0010033":{"id":{"identifier":"GO:0010033","label":"response to organic substance"},"equivalent_identifiers":[{"identifier":"GO:0010033","label":"response to organic substance"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":51.2},"GO:0010389":{"id":{"identifier":"GO:0010389","label":"regulation of G2/M transition of mitotic cell cycle"},"equivalent_identifiers":[{"identifier":"GO:0010389","label":"regulation of G2/M transition of mitotic cell cycle"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":83.9},"GO:0010468":{"id":{"identifier":"GO:0010468","label":"regulation of gene expression"},"equivalent_identifiers":[{"identifier":"GO:0010468","label":"regulation of gene expression"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":49.6},"GO:0016570":{"id":{"identifier":"GO:0016570","label":"histone modification"},"equivalent_identifiers":[{"identifier":"GO:0016570","label":"histone modification"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":65.2},"GO:0018105":{"id":{"identifier":"GO:0018105","label":"peptidyl-serine phosphorylation"},"equivalent_identifiers":[{"identifier":"GO:0018105","label":"peptidyl-serine phosphorylation"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":80.7},"GO:0031453":{"id":{"identifier":"GO:0031453","label":"positive regulation of heterochromatin assembly"},"equivalent_identifiers":[{"identifier":"GO:0031453","label":"positive regulation of heterochromatin assembly"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":89.8},"GO:0031571":{"id":{"identifier":"GO:0031571","label":"mitotic G1 DNA damage checkpoint signaling"},"equivalent_identifiers":[{"identifier":"GO:0031571","label":"mitotic G1 DNA damage checkpoint signaling"}],"type":["biolink:Pathway","biolink:OntologyClass","biolink:BiologicalProcess","biolink:Occurrent","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":94.9},"GO:0032298":{"id":{"identifier":"GO:0032298","label":"positive regulation of DNA-dependent DNA replication initiation"},"equivalent_identifiers":[{"identifier":"GO:0032298","label":"positive regulation of DNA-dependent DNA replication initiation"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":91.9},"GO:0043687":{"id":{"identifier":"GO:0043687","label":"post-translational protein modification"},"equivalent_identifiers":[{"identifier":"GO:0043687","label":"post-translational protein modification"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":73.3},"GO:0045893":{"id":{"identifier":"GO:0045893","label":"positive regulation of transcription, DNA-templated"},"equivalent_identifiers":[{"identifier":"GO:0045893","label":"positive regulation of transcription, DNA-templated"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":66.6},"GO:0051298":{"id":{"identifier":"GO:0051298","label":"centrosome duplication"},"equivalent_identifiers":[{"identifier":"GO:0051298","label":"centrosome duplication"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":100},"GO:0051301":{"id":{"identifier":"GO:0051301","label":"cell division"},"equivalent_identifiers":[{"identifier":"GO:0051301","label":"cell division"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":71.2},"GO:0051321":{"id":{"identifier":"GO:0051321","label":"meiotic cell cycle"},"equivalent_identifiers":[{"identifier":"GO:0051321","label":"meiotic cell cycle"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":89.8},"GO:0071732":{"id":{"identifier":"GO:0071732","label":"cellular response to nitric oxide"},"equivalent_identifiers":[{"identifier":"GO:0071732","label":"cellular response to nitric oxide"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":100},"GO:0090398":{"id":{"identifier":"GO:0090398","label":"cellular senescence"},"equivalent_identifiers":[{"identifier":"GO:0090398","label":"cellular senescence"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":89.8},"GO:1905784":{"id":{"identifier":"GO:1905784","label":"regulation of anaphase-promoting complex-dependent catabolic process"},"equivalent_identifiers":[{"identifier":"GO:1905784","label":"regulation of anaphase-promoting complex-dependent catabolic process"}],"type":["biolink:BiologicalProcess","biolink:Occurrent","biolink:OntologyClass","biolink:BiologicalProcessOrActivity","biolink:BiologicalEntity","biolink:NamedThing","biolink:Entity","biolink:PhysicalEssenceOrOccurrent"],"information_content":91.9}}})

            const query = new q([edge]);
            const res = await query.query();
            expect([...res.reduce((set, record) => set.add(record.recordHash), new Set())]).toHaveLength(28);
        })
    })

    describe.skip("Integration test using text mining co-occurrence KP for disease to chemical association", () => {
        let edge;

        beforeEach(() => {
            const edge_path = path.resolve(__dirname, '../data/cooccurrence_example_edge.json');
            edge = JSON.parse(fs.readFileSync(edge_path));
        })
        test("check response", async () => {
            const query = new q([edge]);
            const res = await query.query(false);
            expect(res).toHaveLength(3762);
        })
    })

    describe("Integration test using fake error api query that should return 404 error", () => {
        let edge;

        beforeEach(() => {
            const edge_path = path.resolve(__dirname, '../data/fake_error_edge.json');
            edge = JSON.parse(fs.readFileSync(edge_path));
        })
        test("check response", async () => {
            const query = new q([edge]);
            const res = await query.query(false);
            expect(res).toHaveLength(0);
            expect(query.logs.some(log => log.level === 'ERROR' ? true : false)).toBeTruthy();
        })
    })

    describe("Integration test using mydisease superclass_of", () => {
        let edges;

        beforeEach(() => {
            const kg = require("@biothings-explorer/smartapi-kg");
            const meta_kg = new kg.default();
            meta_kg.constructMetaKGSync();
            edges = meta_kg.filter({ api_name: "MyDisease.info API", predicate: "superclass_of" });
            edges.map(op => op.input = ["MONDO:0002494"])
        })
        test("check response", async () => {
            // mocking
            axios.get.mockResolvedValue({data: {"_id":"MONDO:0002494","_version":1,"mondo.children":["MONDO:0002491","MONDO:0004938","MONDO:0005567","MONDO:0021698"]}});
            axios.mockResolvedValue({data: [{
              query: 'MONDO:0002494',
              _id: 'MONDO:0002494',
              _score: 9.624479,
              mondo: { children: ["MONDO:0002491","MONDO:0004938","MONDO:0005567","MONDO:0021698"] }
            }]})

            const query = new q(edges);
            const res = await query.query(false);
            const mydisease_res = await axios.get("http://mydisease.info/v1/disease/MONDO:0002494?fields=mondo.children&dotfield=true");
            expect(res.length).toEqual(mydisease_res.data["mondo.children"].length)
        })
    })
})
